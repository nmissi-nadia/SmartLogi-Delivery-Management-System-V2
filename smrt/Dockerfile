# Build stage
FROM maven:3.9.6-eclipse-temurin-17 AS build
WORKDIR /workspace/app
COPY pom.xml .
RUN mvn dependency:go-offline
COPY src src
RUN mvn package -DskipTests

# Run stage
FROM eclipse-temurin:17-jre-jammy

ARG OAUTH2_GOOGLE_CLIENT_ID
ARG OAUTH2_GOOGLE_CLIENT_SECRET
ARG OAUTH2_OKTA_CLIENT_ID
ARG OAUTH2_OKTA_CLIENT_SECRET
ARG OAUTH2_OKTA_ISSUER_URI
ARG APP_JWT_SECRET
ARG APP_FRONTEND_BASE_URL

ENV OAUTH2_GOOGLE_CLIENT_ID=${OAUTH2_GOOGLE_CLIENT_ID}
ENV OAUTH2_GOOGLE_CLIENT_SECRET=${OAUTH2_GOOGLE_CLIENT_SECRET}
ENV OAUTH2_OKTA_CLIENT_ID=${OAUTH2_OKTA_CLIENT_ID}
ENV OAUTH2_OKTA_CLIENT_SECRET=${OAUTH2_OKTA_CLIENT_SECRET}
ENV OAUTH2_OKTA_ISSUER_URI=${OAUTH2_OKTA_ISSUER_URI}
ENV APP_JWT_SECRET=${APP_JWT_SECRET}
ENV APP_FRONTEND_BASE_URL=${APP_FRONTEND_BASE_URL}

COPY --from=build /workspace/app/target/*.jar app.jar
EXPOSE 8084
ENTRYPOINT ["java", "-jar", "app.jar"]

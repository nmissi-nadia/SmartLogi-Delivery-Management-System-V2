pipeline {
    agent any

    environment {
        SONAR_HOST_URL      = "http://localhost:9000"
        SONAR_PROJECT_KEY   = "SmartLogi-DMS"
        DOCKER_IMAGE_NAME   = "smartlogi-app"
        PROJECT_DIR         = "smrt"  // ← IMPORTANT : Le projet Maven est dans ce dossier
    }

    stages {
        stage('Checkout') {
            steps {
                echo "Checking out source code..."
                checkout scm
            }
        }

        stage('Verify Structure') {
            steps {
                echo "Verifying project structure..."
                bat '''
                    echo Current directory:
                    cd
                    echo.
                    echo Root directory contents:
                    dir
                    echo.
                    echo Contents of smrt directory:
                    dir smrt
                    echo.
                    echo Checking for pom.xml in smrt:
                    if exist smrt\\pom.xml (
                        echo [SUCCESS] pom.xml found in smrt directory!
                    ) else (
                        echo [ERROR] pom.xml NOT found in smrt directory!
                        exit /b 1
                    )
                '''
            }
        }

        stage('Compile') {
            steps {
                dir('smrt') {  // ← Changement de répertoire vers smrt
                    echo "Compiling the application..."
                    bat 'mvn clean compile'
                }
            }
        }



        stage('Quality Gate') {
            steps {
                echo "Checking SonarQube Quality Gate status..."
                timeout(time: 5, unit: 'MINUTES') {
                    waitForQualityGate abortPipeline: true
                }
            }
        }

        stage('Build & Tag Docker Image') {
            steps {
                script {
                    echo "Building Docker image..."
                    def imageTag = env.BUILD_NUMBER
                    def latestTag = "latest"
                    def fullImageName = env.DOCKER_IMAGE_NAME

                    // Build depuis le dossier smrt où se trouve le Dockerfile
                    docker.build(fullImageName + ":${imageTag}", "./smrt")
                    docker.image(fullImageName + ":${imageTag}").tag(latestTag)
                }
            }
        }
        
        stage('Push Docker Image') {
            when { branch 'main' }
            steps {
                script {
                    echo "Pushing Docker image to registry..."
                    docker.withRegistry('https://index.docker.io/v1/', 'dockerhub-credentials') {
                        docker.image(env.DOCKER_IMAGE_NAME + ":${env.BUILD_NUMBER}").push()
                        docker.image(env.DOCKER_IMAGE_NAME + ":latest").push()
                    }
                }
            }
        }
    }
    
    post {
        always {
            echo "Pipeline finished. Cleaning up workspace..."
            cleanWs()
        }
        success {
            echo "Pipeline completed successfully!"
        }
        failure {
            echo "Pipeline failed!"
        }
    }
}
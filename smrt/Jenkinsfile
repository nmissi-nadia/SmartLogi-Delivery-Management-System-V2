pipeline {
    agent any

    environment {
        SONAR_HOST_URL      = "http://localhost:9000"
        SONAR_PROJECT_KEY   = "SmartLogi-DMS"
        DOCKER_IMAGE_NAME   = "smartlogi-app"
        // Ajoutez le chemin du projet si n√©cessaire
        PROJECT_DIR         = "smrt"  // Changez si pom.xml est ailleurs
    }

    stages {
        stage('Checkout') {
            steps {
                echo "Checking out source code..."
                checkout scm
            }
        }

        stage('Verify Structure') {
            steps {
                echo "Verifying project structure..."
                bat '''
                    echo Current directory:
                    cd
                    echo.
                    echo Listing files:
                    dir
                    echo.
                    echo Checking for pom.xml:
                    if exist pom.xml (
                        echo [SUCCESS] pom.xml found!
                    ) else (
                        echo [ERROR] pom.xml NOT found!
                        exit /b 1
                    )
                '''
            }
        }

        stage('Compile') {
            steps {
                dir(env.PROJECT_DIR) {
                    echo "Compiling the application..."
                    bat 'mvn clean compile'
                }
            }
        }

        stage('Unit & Integration Tests') {
            steps {
                dir(env.PROJECT_DIR) {
                    echo "Running tests and generating coverage report..."
                    withCredentials([
                        string(credentialsId: 'okta-client-id', variable: 'OAUTH2_OKTA_CLIENT_ID'),
                        string(credentialsId: 'okta-client-secret', variable: 'OAUTH2_OKTA_CLIENT_SECRET'),
                        string(credentialsId: 'okta-issuer-uri', variable: 'OAUTH2_OKTA_ISSUER_URI')
                    ]) {
                        bat 'mvn verify'
                    }
                }
            }
            post {
                always {
                    echo "Archiving test results..."
                    junit "${env.PROJECT_DIR}/target/surefire-reports/**/*.xml"
                    jacoco execPattern: "${env.PROJECT_DIR}/target/jacoco.exec"
                }
            }
        }

        stage('SonarQube Analysis') {
            steps {
                dir(env.PROJECT_DIR) {
                    echo "Performing SonarQube analysis..."
                    withSonarQubeEnv('My-SonarQube') {
                        bat """
                            mvn sonar:sonar ^
                              -Dsonar.projectKey=${env.SONAR_PROJECT_KEY}
                        """
                    }
                }
            }
        }

        stage('Quality Gate') {
            steps {
                echo "Checking SonarQube Quality Gate status..."
                timeout(time: 5, unit: 'MINUTES') {
                    waitForQualityGate abortPipeline: true
                }
            }
        }

        stage('Build & Tag Docker Image') {
            steps {
                script {
                    echo "Building Docker image..."
                    def imageTag = env.BUILD_NUMBER
                    def latestTag = "latest"
                    def fullImageName = env.DOCKER_IMAGE_NAME
                    
                    docker.build(fullImageName + ":${imageTag}", env.PROJECT_DIR)
                    docker.image(fullImageName + ":${imageTag}").tag(latestTag)
                }
            }
        }
        
        stage('Push Docker Image') {
            when { branch 'main' }
            steps {
                script {
                    echo "Pushing Docker image to registry..."
                    docker.withRegistry('https://index.docker.io/v1/', 'dockerhub-credentials') {
                        docker.image(env.DOCKER_IMAGE_NAME + ":${env.BUILD_NUMBER}").push()
                        docker.image(env.DOCKER_IMAGE_NAME + ":latest").push()
                    }
                }
            }
        }
    }
    
    post {
        always {
            echo "Pipeline finished. Cleaning up workspace..."
            cleanWs()
        }
        success {
            echo "Pipeline completed successfully!"
        }
        failure {
            echo "Pipeline failed!"
        }
    }
}